# Gifka Bot

Telegram-бот для добавления надписи к GIF и стикерам. Возвращает результат в корректном формате для дальнейшего использования и/или добавления в пакеты через официальный @Stickers бот.

**Ссылка на бота**: @ReallyCoolGifkaBot

---

## Основной функционал

* Интерактивный сценарий добавления подписи:
  - Отправьте текст подписи
  - Пришлите GIF или стикер — бот вернёт обработанный файл
* Поддерживаемые форматы источников:
  - Статичные стикеры (WebP)
  - Анимированные стикеры (WebM)
  - GIF-изображения (как анимация/MP4)
* Стартовое приветствие и помощь по сценарию взаимодействия

---

## Технологический стек

| Компонент       | Технология / Версия                                 | Назначение                           |
|-----------------|-------------------------------------------------------|--------------------------------------|
| Язык            | Go 1.25                                              | Основной язык реализации             |
| Telegram API    | [go-telegram/bot](https://github.com/go-telegram/bot) | Работа с Telegram Bot API            |
| UI/Keyboards    | [go-telegram/ui](https://github.com/go-telegram/ui)   | Инлайн‑клавиатуры                    |
| Графика/Текст   | [fogleman/gg](https://github.com/fogleman/gg), [imaging](https://github.com/disintegration/imaging), [webp](https://github.com/chai2010/webp) | Рендер текста и работа с изображениями |
| Видеопроцессинг | ffmpeg                                               | Обработка видео/кадров               |
| Логирование     | [Zap](https://github.com/uber-go/zap)                | Структурированное логирование        |
| Контейнеризация | Docker, Docker Compose                               | Локальный запуск и деплой            |
| Автоматизация   | Ansible                                              | Деплой на удалённый сервер           |

---

## Команды бота

| Команда   | Описание                                                                 |
|-----------|---------------------------------------------------------------------------|
| `/start`  | Приветствие и запуск основного сценария. Показывает кнопку «Add Black Box» |

Примечание: дальше взаимодействие проходит через инлайн‑кнопку и сообщения (текст → медиа).

---

## Локальный запуск

### 1. Подготовить окружение
Создайте файл `.env` в корне проекта (или экспортируйте переменную окружения):

```env
TELEGRAM_BOT_TOKEN=<ваш_tg_token>
```

Если планируете запуск вне контейнера, убедитесь, что локально установлен `ffmpeg`.

### 2. Запуск через Docker Compose

```bash
docker-compose up -d
```

Образ по умолчанию: `eduard3000/gifka-bot:latest`. Контейнер ожидает `TELEGRAM_BOT_TOKEN` из `.env`.

### 3. Запуск из исходников (альтернатива)

```bash
make build
./bin/gifka-bot
```

---

## Конфигурация

Проект считывает настройки из переменных окружения:

- `TELEGRAM_BOT_TOKEN` — токен Telegram‑бота (обязателен)

Файл `config/config.go` — минимальный провайдер конфигурации.

---

## CI/CD и деплой через Ansible

Проект содержит плейбук Ansible для деплоя.

Структура:
```
bot_playbook/
├── deploy.yml                 # Основной плейбук деплоя
├── group_vars/
│   └── vars.yml               # Переменные окружения (можно шифровать Vault’ом)
├── inventories/
│   └── gifka-bot.ini          # Инвентори-файл с параметрами подключения к ВМ
└── ..
```

Шифрование переменных окружения (рекомендуется):
```bash
ansible-vault encrypt bot_playbook/group_vars/vars.yml
```

Пример инвентори (`bot_playbook/inventories/gifka-bot.ini`):
```ini
[all]
<vm-host> ansible_ssh_port=<ssh-port> ansible_ssh_user=<ssh-user>
```

Ручной деплой:
```bash
ansible-playbook -i bot_playbook/inventories/gifka-bot.ini bot_playbook/deploy.yml
```

---

## Архитектура и ключевые файлы

- `cmd/gifka-bot/main.go` — точка входа
- `internal/app/app.go` — инициализация бота, регистрация хендлеров и middleware
- `internal/handlers/*` — обработчики команд, сообщений и сценариев
- `internal/media_processor/*` — обработка изображений/видео, генерация подписи
- `docker-compose.yml`, `Dockerfile` — контейнеризация
- `ansible.cfg`, `bot_playbook/` — деплой

---

## Требования/зависимости рантайма

- `ffmpeg` — должен быть доступен в окружении исполнения (в Docker‑образе уже устанавливается)
- Шрифты для рендеринга текста: директория `text_style/` (встраивается в образ)

---

## ToDo
- [ ] Валидация длины/размера текста и авто‑перенос строк ограничены — возможны визуальные артефакты на длинных подписях.
- [ ] Вынести ffmpeg‑параметры в конфиг:
    - битрейт/CRF/длительность/размер/позиция оверлея — через `config.yaml` или переменные окружения.
- [ ] Улучшить сообщения об ошибках и кейсы с неподдерживаемыми форматами (tgs)
- [ ] Лимитирование частоты/размера входящих медиа, защита от злоупотреблений
- [ ] GitHub Actions для CI (линт, сборка образа, публикация)
- [ ] Е2Е/интеграционные тесты медиа‑пайплайна (обёртка над ffmpeg)

